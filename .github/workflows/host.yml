name: Nekoo Host

on:
  workflow_dispatch:
  schedule:
    - cron: '40 3 * * *'

jobs:
  host:
    runs-on: ubuntu-latest
    timeout-minutes: 340

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env
          rustc --version

      - name: Build Nekoo
        run: |
          source $HOME/.cargo/env
          cargo build --release
          ls -lh target/release/nekoo

      - name: Restore Database
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          set +e
          mkdir -p temp_uploads
          echo "Restoring database from backups..."
          BACKUP_REPOS="azkookookoo/nekoo-host nopainnotraind/nekoo-host xToWBs/nekoo-host cowgirlsz/nekoo-host vvvcertambos/nekoo-host DaryoshKhiyam/nekoo-host avimf2005/nekoo-host avi8427/nekoo-host annarajak01/nekoo-host rajaksuhani09/nekoo-host leelavatirajak1/nekoo-host git1one/nekoo-host ballpooltracer/nekoo-host thatwassillybigrob/nekoo-host ankeshsingh77173-wq/nekoo-host baharamad8/nekoo-host dunyatarik628/nekoo-host faceofgits/nekoo-host maxytmaxyt1212-boop/nekoo-host akashseh261-alt/nekoo-host nyt44040-stack/nekoo-host pandeysangeeta1981-dev/nekoo-host manas807897-ui/nekoo-host sahilrajak2411-afk/nekoo-host sahilrajak1107-hash/nekoo-host sakesh277/nekoo-host"
          DB_RESTORED=false
          for REPO in $BACKUP_REPOS; do
            if [ "$DB_RESTORED" = true ]; then break; fi
            echo "  Trying $REPO..."
            RELEASE_JSON=$(curl -sfS -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/$REPO/releases/tags/db-backup" 2>/dev/null || echo "{}")
            DOWNLOAD_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[]? | select(.name == "nekoo.db") | .url' 2>/dev/null || echo "")
            if [ -n "$DOWNLOAD_URL" ] && [ "$DOWNLOAD_URL" != "null" ]; then
              curl -sL -H "Authorization: token $GH_TOKEN" -H "Accept: application/octet-stream" "$DOWNLOAD_URL" -o nekoo.db.tmp 2>/dev/null
              TMP_SIZE=$(stat -c%s nekoo.db.tmp 2>/dev/null || echo "0")
              if [ "$TMP_SIZE" -gt 100 ]; then
                mv nekoo.db.tmp nekoo.db
                echo "  DB restored from $REPO ($TMP_SIZE bytes)"
                DB_RESTORED=true
              else
                rm -f nekoo.db.tmp
              fi
            fi
          done
          if [ "$DB_RESTORED" = false ]; then
            echo "No backup found, starting fresh"
            touch nekoo.db
          fi
          set -e

      - name: Create .env
        env:
          ADMIN_KEY: ${{ secrets.ADMIN_KEY }}
        run: |
          echo "ADMIN_KEY=$ADMIN_KEY" > .env
          echo "RUST_LOG=nekoo=info" >> .env

      - name: Start Services
        env:
          TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          chmod +x cloudflared-linux-amd64
          source $HOME/.cargo/env
          nohup ./target/release/nekoo > nekoo.log 2>&1 &
          NEKOO_PID=$!
          sleep 5
          if kill -0 $NEKOO_PID 2>/dev/null; then
            echo "Nekoo running (PID: $NEKOO_PID)"
          else
            echo "Nekoo failed"; cat nekoo.log; exit 1
          fi
          curl -s http://localhost:3000/health || echo "Health check pending"
          head -20 nekoo.log
          nohup ./cloudflared-linux-amd64 tunnel --no-autoupdate run --token $TUNNEL_TOKEN > tunnel.log 2>&1 &
          TUNNEL_PID=$!
          echo "Tunnel started (PID: $TUNNEL_PID)"
          sleep 10
          head -20 tunnel.log
          REPO_FULL="${{ github.repository }}"
          EXISTING=$(curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/$REPO_FULL/releases/tags/db-backup" | jq -r '.id // empty')
          if [ -z "$EXISTING" ]; then
            curl -s -X POST -H "Authorization: token $GH_TOKEN" -H "Content-Type: application/json" "https://api.github.com/repos/$REPO_FULL/releases" -d '{"tag_name":"db-backup","name":"Database Backup","body":"Auto-managed","prerelease":true}' || true
          fi
          backup_db() {
            local REPO_FULL="${{ github.repository }}"
            local RELEASE_ID=$(curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/$REPO_FULL/releases/tags/db-backup" | jq -r '.id // empty')
            if [ -n "$RELEASE_ID" ]; then
              local OLD_ASSET=$(curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/$REPO_FULL/releases/$RELEASE_ID/assets" | jq -r '.[]? | select(.name == "nekoo.db") | .id' 2>/dev/null || echo "")
              if [ -n "$OLD_ASSET" ]; then
                curl -s -X DELETE -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/$REPO_FULL/releases/assets/$OLD_ASSET" || true
              fi
              curl -s -X POST -H "Authorization: token $GH_TOKEN" -H "Content-Type: application/octet-stream" "https://uploads.github.com/repos/$REPO_FULL/releases/$RELEASE_ID/assets?name=nekoo.db" --data-binary @nekoo.db > /dev/null
              echo "[$(date)] DB backed up"
            fi
          }
          echo "Monitoring..."
          BACKUP_COUNTER=0
          for i in $(seq 1 340); do
            sleep 60
            if ! kill -0 $NEKOO_PID 2>/dev/null; then
              echo "Nekoo died!"; tail -50 nekoo.log; backup_db; exit 1
            fi
            if ! kill -0 $TUNNEL_PID 2>/dev/null; then
              echo "Tunnel died!"; tail -50 tunnel.log; backup_db; exit 1
            fi
            BACKUP_COUNTER=$((BACKUP_COUNTER + 1))
            if [ $((BACKUP_COUNTER % 5)) -eq 0 ]; then backup_db; fi
            if [ $((i % 30)) -eq 0 ]; then
              echo "[$i min] Running"
            fi
          done
          echo "Final backup..."
          backup_db
