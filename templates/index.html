<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Neko File Hosting</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Neko File Hosting - Fast, secure, and simple file hosting service. Max 2GB per file. Free unlimited uploads.">
    <link rel="icon" type="image/png" href="/logo.png">

    <style>
        body {
            background-color: #f0f0f0;
            color: #111;
            font-family: monospace;
            padding: 15px;
            margin: 0;
            min-height: 100vh;
            box-sizing: border-box;
            position: relative;
            line-height: 1.3;
            font-size: 13px;
            /* Smaller font as requested */
        }

        h1 {
            font-size: 16px;
            /* Smaller header */
            margin: 0 0 10px 0;
            font-weight: bold;
        }

        a {
            color: #0000EE;
            text-decoration: underline;
        }

        /* URL links that wrap properly on mobile */
        .url-link {
            word-break: break-all;
            overflow-wrap: break-word;
            display: inline-block;
            max-width: 100%;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .content-box {
            background: #fff;
            border: 2px solid #333;
            padding: 20px;
            margin-top: 20px;
        }

        main {
            display: block;
        }

        #progress-container {
            display: none;
            width: 100%;
            max-width: 400px;
            border: 2px solid #333;
            background: #fff;
            height: 12px;
            margin-top: 15px;
        }

        #progress-bar {
            width: 0%;
            height: 100%;
            background-color: #333;
        }

        /* Unified Button/Link Style */
        .btn,
        button,
        select,
        input[type="file"]::file-selector-button {
            font-family: monospace;
            cursor: pointer;
            border: 2px solid #333;
            background: #e0e0e0;
            color: #000;
            padding: 6px 12px;
            font-weight: bold;
            font-size: 12px;
            /* Smaller text */
            text-decoration: none;
            display: inline-block;
            box-sizing: border-box;
            vertical-align: middle;
            margin: 2px;
            min-height: 0;
            /* Removing forced big height */
        }

        .btn:hover,
        button:hover {
            background: #ccc;
        }

        .btn:active,
        button:active {
            background: #fff;
        }

        .btn.red {
            background: #cc0000;
            color: white;
            border-color: #990000;
        }

        .btn.red:hover {
            background: #aa0000;
        }

        select,
        input[type="text"],
        input[type="file"] {
            padding: 5px;
            border: 2px solid #333;
            background: #fff;
            font-family: monospace;
            font-size: 12px;
            vertical-align: middle;
        }

        /* Overlay for drag drop */
        #dragOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            font-weight: bold;
            z-index: 999;
            pointer-events: none;
        }

        .header {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
            flex-wrap: wrap;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-area img {
            width: 50px;
            /* Smaller */
            height: 50px;
            object-fit: contain;
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .logo-title {
            font-size: 20px;
            font-weight: bold;
            line-height: 1.1;
        }

        .logo-subtitle {
            font-size: 10px;
            margin-top: 2px;
        }

        :focus {
            outline: 2px solid #000;
            outline-offset: 1px;
        }
    </style>
</head>

<body>
    <div id="dragOverlay">DROP FILES TO UPLOAD</div>

    <div class="container">
        <header style="margin-bottom: 20px;">
            <div class="logo-area">
                <img src="/logo.webp" alt="Neko Hosting Logo">
                <div class="logo-text">
                    <div class="logo-title">neko</div>
                    <div class="logo-subtitle"><span id="totalStorage">Loading...</span></div>
                </div>
            </div>
        </header>

        <div class="content-box">
            <main>
                <h1 style="text-align: center; margin-bottom: 20px;">Upload meow</h1>
                <p style="text-align: center; margin-bottom: 20px; font-size: 12px;">Drag files, paste, or click below
                </p>

                <form id="uploadForm" style="text-align: center;">
                    <label for="fileInput" style="display:none;">Select Files</label>
                    <input type="file" id="fileInput" name="file" multiple style="display:none;">

                    <div style="margin-bottom: 15px;">
                        <button type="button" onclick="document.getElementById('fileInput').click()"
                            style="padding: 10px 20px; font-size: 13px;">[ SELECT FILES ]</button>
                    </div>

                    <div id="fileList" style="margin: 15px 0; font-weight:bold; min-height: 20px;"></div>

                    <button type="submit" id="uploadBtn"
                        style="display:none; margin-top: 15px; padding: 10px 25px; font-size: 13px; background: #ccc;">
                        [ START UPLOAD ]
                    </button>
                </form>

                <div id="progress-container" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    <div id="progress-bar"></div>
                </div>

                <div id="status-text" aria-live="polite"
                    style="display:none; margin-top:20px; text-align: left; padding: 10px; border: 2px dashed #333; max-width: 100%; font-weight:bold; background:#f9f9f9;">
                </div>
            </main>
        </div>

        <footer style="margin-top:15px; font-size:11px; color:#333; padding-bottom: 10px; text-align: center;">
            &copy; <span id="year">2005</span> Neko Corp. &bull; v1.5<br>
            <a href="/help" style="color:#333;">[ HELP ]</a> &bull;
            <a href="/terms" style="color:#333;">[ TERMS ]</a> &bull;
            <a href="/help#api" style="color:#333;">[ API ]</a> &bull;
            <a href="mailto:help@nekoo.ru" style="color:#333;">[ CONTACT ]</a>
        </footer>
    </div>
    <script>
        document.getElementById('year').innerText = new Date().getFullYear();
        // Fetch and display total storage
        fetch('/api/stats').then(r => r.json()).then(data => {
            document.getElementById('totalStorage').innerText = data.total_gb + ' GB';
        }).catch(() => {
            document.getElementById('totalStorage').innerText = '0.00 GB';
        });
    </script>

    <script>
        var body = document.body;
        var overlay = document.getElementById('dragOverlay');
        var fileInput = document.getElementById('fileInput');
        var fileListDisplay = document.getElementById('fileList');
        var uploadBtn = document.getElementById('uploadBtn');
        var selectedFiles = [];
        var dragCounter = 0;

        // --- PASTE SUPPORT ---
        document.onpaste = function (event) {
            var items = (event.clipboardData || event.originalEvent.clipboardData).items;
            var files = [];
            for (var index in items) {
                var item = items[index];
                if (item.kind === 'file') {
                    var blob = item.getAsFile();
                    if (!blob.name) {
                        blob.name = 'pasted_image_' + Date.now() + '.png';
                    }
                    files.push(blob);
                } else if (item.kind === 'string' && item.type === 'text/plain') {
                    item.getAsString(function (s) {
                        if (s && s.trim().length > 0) {
                            var textBlob = new File([s], "pasted_text.txt", { type: "text/plain" });
                            handleFiles([textBlob]);
                        }
                    });
                }
            }
            if (files.length > 0) {
                handleFiles(files);
            }
        };

        window.addEventListener('dragenter', function (e) {
            e.preventDefault();
            dragCounter++;
            overlay.style.display = 'flex';
        });

        window.addEventListener('dragleave', function (e) {
            e.preventDefault();
            dragCounter--;
            if (dragCounter === 0) {
                overlay.style.display = 'none';
            }
        });

        window.addEventListener('dragover', function (e) {
            e.preventDefault();
        });

        window.addEventListener('drop', function (e) {
            e.preventDefault();
            dragCounter = 0;
            overlay.style.display = 'none';
            handleFiles(e.dataTransfer.files);
        });

        fileInput.onchange = function () {
            handleFiles(this.files);
        };

        function handleFiles(files) {
            if (files.length > 0) {
                if (files instanceof FileList) {
                    files = Array.from(files);
                }
                selectedFiles = files;
                var listHtml = "SELECTED:<br>";
                for (var i = 0; i < files.length; i++) {
                    var f = files[i];
                    var s = (f.size > 1024 * 1024 * 1024) ? (f.size / 1024 / 1024 / 1024).toFixed(2) + " GB" :
                        (f.size > 1024 * 1024) ? (f.size / 1024 / 1024).toFixed(2) + " MB" :
                            (f.size / 1024).toFixed(0) + " KB";
                    listHtml += "â€¢ " + escapeHtml(f.name) + " (" + s + ")<br>";
                }
                fileListDisplay.innerHTML = listHtml;
                uploadBtn.style.display = 'inline-block';
            }
        }


        var CHUNK_SIZE = 90 * 1024 * 1024; // 90MB chunks (under Cloudflare 100MB limit)

        function displayResults(status, data) {
            status.innerHTML = "<b>RESULTS:</b>";
            var files = data.files;
            var html = "";
            for (var i = 0; i < files.length; i++) {
                var item = files[i];
                var size_str = (item.size > 1024 * 1024 * 1024) ? (item.size / 1024 / 1024 / 1024).toFixed(2) + " GB" :
                    (item.size > 1024 * 1024) ? (item.size / 1024 / 1024).toFixed(2) + " MB" :
                        (item.size / 1024).toFixed(0) + " KB";
                var viewLink = "/view/" + item.slug;
                var ext = item.original_filename.split('.').pop().toLowerCase();
                var codeExts = ['txt', 'md', 'rs', 'c', 'cpp', 'h', 'hpp', 'py', 'js', 'ts', 'jsx', 'tsx', 'html', 'css', 'json', 'yaml', 'yml', 'toml', 'xml', 'sh', 'bash', 'zsh', 'bat', 'ps1', 'php', 'rb', 'lua', 'go', 'java', 'kt', 'swift', 'cs', 'sql', 'ini', 'cfg', 'conf', 'log', 'csv', 'svg'];
                var viewCodeBtn = "";
                if (codeExts.indexOf(ext) !== -1) {
                    viewCodeBtn = " <a href='" + viewLink + "' target='_blank' class='btn' style='font-size:10px; padding:3px 6px;'>VIEW CODE</a>";
                }
                html += "<div style='margin-bottom:8px; border-bottom:1px dashed #666; padding-bottom:8px;'>" +
                    "<strong>" + escapeHtml(item.original_filename) + "</strong> (" + size_str + ")<br>" +
                    "ID: " + item.id + "<br>" +
                    "<a href='" + item.url + "' target='_blank' class='url-link'>" + item.url + "</a> " +
                    "<button onclick='copyToClipboard(\"" + item.url + "\")' class='btn' style='font-size:10px; padding:3px;'>COPY</button>" +
                    viewCodeBtn +
                    "<div style='margin-top:8px;'><img src='https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=" + encodeURIComponent(item.url) + "' alt='QR'></div>" +
                    "</div>";
            }
            var d = document.createElement('div');
            d.innerHTML = html;
            status.appendChild(d);
        }

        async function uploadChunked(file, pBar, pContainer, status) {
            var totalChunks = Math.ceil(file.size / CHUNK_SIZE);
            var uploadId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            for (var i = 0; i < totalChunks; i++) {
                var start = i * CHUNK_SIZE;
                var end = Math.min(start + CHUNK_SIZE, file.size);
                var chunk = file.slice(start, end);

                var formData = new FormData();
                formData.append('file', chunk, file.name);
                formData.append('upload_id', uploadId);
                formData.append('chunk_index', i.toString());
                formData.append('total_chunks', totalChunks.toString());
                formData.append('original_filename', file.name);
                formData.append('total_size', file.size.toString());

                var percentBase = (i / totalChunks) * 100;
                var percentNext = ((i + 1) / totalChunks) * 100;

                // Upload this chunk with XHR for progress
                await new Promise(function (resolve, reject) {
                    var xhr = new XMLHttpRequest();
                    xhr.upload.onprogress = function (e) {
                        if (e.lengthComputable) {
                            var chunkProgress = (e.loaded / e.total);
                            var totalProgress = percentBase + (chunkProgress * (percentNext - percentBase));
                            pBar.style.width = totalProgress + '%';
                            var prog = document.getElementById('prog-text');
                            if (prog) prog.innerText = "UPLOADING: " + totalProgress.toFixed(0) + "%";
                        }
                    };
                    xhr.onload = function () {
                        if (xhr.status === 200) resolve(xhr.responseText);
                        else reject(new Error("Chunk " + i + " failed: " + xhr.statusText));
                    };
                    xhr.onerror = function () { reject(new Error("Network error on chunk " + i)); };
                    xhr.open('POST', '/api/upload-chunk', true);
                    xhr.send(formData);
                });
            }

            // Finalize the upload
            var finalResp = await fetch('/api/upload-finalize', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ upload_id: uploadId, original_filename: file.name, total_size: file.size })
            });
            return await finalResp.json();
        }

        document.getElementById('uploadForm').onsubmit = function (event) {
            event.preventDefault();
            if (selectedFiles.length === 0 && fileInput.files.length === 0) {
                alert("Select files first!");
                return;
            }

            var pBar = document.getElementById('progress-bar');
            var pContainer = document.getElementById('progress-container');
            var status = document.getElementById('status-text');

            pContainer.style.display = 'block';
            pBar.style.width = '0%';
            pBar.style.backgroundColor = '#333';
            status.style.display = 'block';
            status.innerText = "STARTING...";
            uploadBtn.style.display = 'none';

            (async function () {
                var files = selectedFiles.length > 0 ? selectedFiles : Array.from(fileInput.files);
                if (files.length === 0) {
                    status.innerText = "No files selected";
                    pContainer.style.display = 'none';
                    return;
                }

                status.innerHTML = "<b>UPLOADING...</b><br><div id='prog-text' style='font-weight:bold; color:blue;'>0%</div>";

                try {
                    var allResults = [];
                    for (var fi = 0; fi < files.length; fi++) {
                        var file = files[fi];
                        if (file.size > CHUNK_SIZE) {
                            // Large file: use chunked upload
                            var result = await uploadChunked(file, pBar, pContainer, status);
                            if (result.files) allResults = allResults.concat(result.files);
                        } else {
                            // Small file: use direct upload
                            var formData = new FormData();
                            formData.append('file', file);
                            var result = await new Promise(function (resolve, reject) {
                                var xhr = new XMLHttpRequest();
                                xhr.upload.onprogress = function (e) {
                                    if (e.lengthComputable) {
                                        var p = (e.loaded / e.total) * 100;
                                        pBar.style.width = p + '%';
                                        var prog = document.getElementById('prog-text');
                                        if (prog) prog.innerText = "UPLOADING: " + p.toFixed(0) + "%";
                                    }
                                };
                                xhr.onload = function () {
                                    if (xhr.status === 200) resolve(JSON.parse(xhr.responseText));
                                    else reject(new Error(xhr.statusText));
                                };
                                xhr.onerror = function () { reject(new Error("Network error")); };
                                xhr.open('POST', '/upload', true);
                                xhr.send(formData);
                            });
                            if (result.files) allResults = allResults.concat(result.files);
                        }
                    }
                    pContainer.style.display = 'none';
                    displayResults(status, { files: allResults });
                } catch (e) {
                    console.error(e);
                    pContainer.style.display = 'none';
                    status.innerText = "UPLOAD FAILED: " + e.message;
                    pBar.style.backgroundColor = 'red';
                }
            })();
        };

        function escapeHtml(text) {
            var map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, function (m) { return map[m]; });
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function () {
                alert('COPIED!');
            }, function (err) {
                console.error('Could not copy text: ', err);
            });
        }



    </script>
</body>

</html>